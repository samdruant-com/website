# Auto-merge Dependabot PRs

name: Auto Merge Dependabot PRs

on:
  pull_request:
    types:
      - labeled
    branches:
      - main

  schedule:
    - cron: "30 2 * * *"

jobs:
  merge-prs:
    name: Merge Dependabot PRs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      # This step merges any of the Dependabot PRs with "safe-updates" in the title. The "safe-updates" refers to the
      # Dependabot group defined in dependabot.yaml
      - name: Merge Safe Dependabot PRs
        run: |
          for pr_number in $(gh pr list --state open --author 'dependabot[bot]' --json number | jq -r '.[] | .number'); do
            TITLE=$(gh pr view $pr_number --json title --jq '.title')

            if [[ "$TITLE" == *'safe-updates'* ]]; then
              echo "::notice :: Merging PR ${pr_number}"
              gh pr merge --squash --delete-branch $pr_number
            else
              echo "::warning :: Skipping PR ${pr_number} because the title, '$TITLE', doesn't contain 'safe-updates'"
            fi
          done
        env:
          # This PAT requires the following scopes:
          # - [pullrequest:read] to inspect PRs
          # - [content:write] for merging pull requests
          # - [workflow:write] for updating deps in workflows
          GH_TOKEN: ${{ secrets.AUTO_MERGE_TOKEN }}
